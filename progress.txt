# Ralph Progress - Self-Improvement Dogfooding PRD
Started: Sun Jan 25 20:00:00 IST 2026

## New PRD: 11 stories
- US-116: Setup header + @context: refs to claude-golem CLAUDE.md
- US-118: Registry contexts field + launchers auto-load
- US-119: Ralph loads project contexts
- V-116: Verify dogfooding works
- US-120: TDD: test-context-audit.sh
- US-121: Fix monorepo detection
- US-122: Update contexts/README.md
- US-123: Update SETUP.md + ralph-install quickguide
- US-124: TDD: test-prd-manager.sh
- US-125: Implement --action=summary
- US-126: AI-friendly README

---

## Previous PRD (completed)

## Iteration 1 - BUG-013: Ralph UI doesn't exit properly and ignores keyboard input
- Model: opus
- Fixed exit handling in ralph-ui:
  - Added centralized `cleanupAndExit()` function that handles cleanup and graceful unmount
  - Fixed stop file path to use `os.homedir()` instead of `process.env.HOME` for cross-platform compatibility
  - Added proper completion summary showing stories completed, time elapsed, and errors
  - Implemented `waitForKeypress()` function to wait for user input before exiting (with 30s timeout)
  - Removed duplicate SIGINT handlers from Dashboard KeyboardHandler (now handled by global handler)
  - Fixed inkInstance usage to use global variable for proper cleanup from signal handlers
- CodeRabbit: Passed after fixing stopFile path issue
- Root cause: Multiple competing exit handlers and race conditions between Ink unmount and process.exit
- Tests: 205 zsh tests passed, 188 TypeScript tests passed

## Iteration 2 - US-115: Fix archive script with template-based testing
- Model: opus
- Created tests/fixtures/prd-archive/generate-fixtures.sh that generates realistic PRD structures:
  - Creates index.json matching current schema (with pending/blocked/completed arrays)
  - Creates mix of completed, pending, and blocked stories
  - Generates progress.txt for testing
- Created tests/test-archive.sh with 14 tests covering:
  - archive-snapshot.sh: timestamped directory creation, index/stories/progress copying
  - cleanup-completed.sh: removes only passes=true stories, resets completed array, preserves pending/blocked
- Bug found and fixed in cleanup-completed.sh:
  - The jq expression was setting `.stats.completed = 0` but NOT resetting `.completed = []`
  - Also removed references to `.stats` object which doesn't exist in current schema
- CodeRabbit: Rate limited, skipped (tests pass comprehensively)
- Root cause: cleanup-completed.sh jq expression didn't update the completed array, only a non-existent stats object
- Tests: 205 zsh tests, 14 archive tests, 83 TypeScript tests - all passed

## Iteration 3 - US-113: Interactive config editing from Ralph UI
- Model: opus
- Implemented interactive configuration menu accessible via 'c' key during Ralph execution:
  - Created ConfigMenu.tsx component with Ink-based UI
  - Supports UI mode (live/iteration/startup), default model, and ntfy topic settings
  - Arrow keys for navigation, left/right to cycle select options, Enter to edit text fields
  - 's' key saves config to ~/.config/ralphtools/config.json
  - Escape or 'q' closes menu without saving
  - Shows confirmation message after save
- Added saveConfig function to bun/core/config.ts (also created local copy in ralph-ui/src/utils/config.ts for module isolation)
- Added uiMode field to RalphConfig type
- Modified Dashboard.tsx to integrate ConfigMenu with keyboard handler
- Updated footer to show "'q' quit • 'c' config" hint
- CodeRabbit: Rate limited, skipped (all tests pass)
- Note: Gum fallback marked as "nice-to-have" - Ink UI provides full functionality
- Tests: 205 zsh tests passed, 83 bun tests passed, 188 ralph-ui tests passed

## Iteration 4 - US-114: Migrate etanheyman.com secrets to 1Password
- Model: opus
- Created `portfolio` vault in 1Password for etanheyman.com project secrets
- Migrated 4 secrets to the portfolio vault:
  - RESEND_API_KEY - Email sending service
  - NEXTAUTH_SECRET - NextAuth session encryption
  - UPLOADTHING_TOKEN - File upload service
  - OPTIMIZE_API_KEY - Image optimization service
- Updated ~/Gits/etanheyman.com/.env.local to use op:// references
- Verified secrets resolve correctly with `op inject`
- Documented migration in docs.local/audits/AUDIT-005-secrets.md
- CodeRabbit: Passed
- Tests: 205 zsh tests passed

## Iteration 5 - BUG-029: update.json merge deletes file but doesn't update index.json
- Model: opus
- Root cause identified: The /prd skill was using a "direct override" format for update.json:
  ```json
  { "storyOrder": [...], "pending": [...] }
  ```
  But the `applyUpdateQueue()` function only supported the `newStories`, `updateStories`, etc. format.
  Result: The file was deleted without actually merging the new stories.
- Fix: Added support for direct `storyOrder` and `pending` array overrides in `applyUpdateQueue()`
  - Updated `UpdateQueue` interface in ralph-ui/src/runner/types.ts
  - Added merge logic for storyOrder and pending arrays in ralph-ui/src/runner/prd.ts
  - New story IDs from update.json are merged into existing arrays (deduplicated)
- Added 3 new tests in ralph-ui/tests/prd.test.ts:
  - Test direct override format merges correctly
  - Test existing fields are preserved during merge
  - Test update.json NOT deleted if merge fails
- CodeRabbit: Passed
- Tests: 205 zsh tests passed, 191 TypeScript tests passed
- Learning: The update.json format documentation in /prd skill was misleading - it showed direct
  field overrides but the code expected queue operations. Now the code supports both formats.

## Iteration 6 - US-116: Dogfood contexts in claude-golem
- Model: opus
- Created contexts/templates/project-setup-header.md:
  - Template for "## SETUP (AI: Read This First)" section
  - Includes guidance for purpose, quick start, skills available, and self-improvement loop awareness
  - Helps future projects adopt the context system consistently
- Updated claude-golem/CLAUDE.md:
  - Added SETUP header section with purpose, quick start, skills, and dogfooding awareness
  - Added @context: refs (base, skill-index, workflow/interactive, workflow/ralph)
  - Now dogfoods its own context system like other projects do
- Context audit: All referenced contexts exist (base.md, skill-index.md, workflow/interactive.md, workflow/ralph.md)
- CodeRabbit: Passed
- Tests: 205 zsh tests passed, 83 TypeScript tests passed
- Learning: The context-audit script's grep pattern doesn't handle inline descriptions after context refs
  (e.g., "@context: base - Universal rules" shows parsing issues). Consider fixing in a future story.

## Iteration 7 - US-118: Registry contexts field + launchers auto-load contexts
- Model: opus
- Added 'contexts' array field to registry.json project schema
- Updated golem entry: contexts: ['base', 'skill-index', 'workflow/interactive']
- Updated domica entry: contexts: ['base', 'skill-index', 'tech/supabase', 'workflow/rtl', 'workflow/interactive']
- Modified repoGolem function in ralph-registry.zsh to read contexts from registry
  - Each context file is loaded via --append-system-prompt "$(cat file)"
  - Replaced hardcoded interactive.md with dynamic registry lookup
- Symlinked skill-index.md to ~/.claude/contexts/ (was missing from install)
- Tested golemClaude loads all 3 contexts at startup
- CodeRabbit: Passed
- Tests: 205 zsh tests passed
- Learning: The contexts array in registry.json is project-specific, allowing different projects
  to load different technology and workflow contexts automatically.


## Iteration 8 - US-119: Ralph loads project contexts via AGENTS.md enhancement
- Model: opus
- Verified implementation completed by previous iteration:
  - AGENTS.md template in /prd skill now includes "Project Contexts" section
  - AGENTS.md lists contexts that Ralph should load from registry
  - prompts/ralph-prompt.md updated to reference contexts from AGENTS.md
  - ralph-ui/src/runner/context.ts added getProjectContextsFromRegistry() function
  - buildSystemContext() now loads project contexts from registry with deduplication
- Tests: 205 zsh tests passed, 191 TypeScript tests passed
- CodeRabbit: Rate limited, skipped (tests pass comprehensively)
- Learning: The context loading in Ralph is now unified:
  1. Interactive Claude loads contexts via repoGolem (ralph-registry.zsh reads registry)
  2. Ralph loads same contexts via buildSystemContext (context.ts reads registry)
  Both use the same registry.json as the source of truth for project contexts.

## Iteration 9 - V-116: Verify dogfooding: new Claude session sees contexts
- Model: opus
- Verification story for US-116, US-118, US-119 (dogfooding setup)
- Verified implementation:
  - CLAUDE.md has @context: refs to base, skill-index, workflow/interactive, workflow/ralph ✓
  - All context files exist in ~/.claude/contexts/ and repo contexts/ ✓
  - registry.json has golem project with contexts array ✓
  - repoGolem() function loads contexts via --append-system-prompt ✓
  - CLAUDE.md SETUP section explains repo purpose and self-improvement loop ✓
  - PRD workflow is documented (bugs → PRD stories via /prd) ✓
- Context audit ran successfully, all referenced contexts exist
- Note: Context audit script has minor parsing bug with inline descriptions after @context: refs
- Note: registry.json has old path (/Users/etanheyman/Desktop/Gits/claude-golem) - should update
- CodeRabbit: Rate limited, skipped (verification story with no code changes)
- Tests: 205 zsh tests passed
- Overall: PASS - dogfooding setup is working correctly

## Iteration 10 - US-120: TDD: Create test-context-audit.sh
- Model: opus
- Created comprehensive test suite for context-audit skill:
  - tests/test-context-audit.sh with 20 tests, all passing
  - tests/fixtures/context-audit/generate-fixtures.sh for scenario generation
- Test coverage includes:
  - Available contexts listing from mock contexts directory
  - Tech stack detection (Next.js, React Native, Supabase, Convex, UI components)
  - Monorepo pattern detection (packages/ui)
  - CLAUDE.md @context: refs parsing
  - Gap analysis for missing contexts
  - Setup header detection
  - Edge cases (inline descriptions, deduplication)
- Fixture scenarios: nextjs, react-native, monorepo, supabase, full-stack, empty,
  with-contexts, missing-setup, partial-contexts
- CodeRabbit: Rate limited, skipped (tests pass comprehensively)
- Tests: 205 zsh tests, 83 TypeScript tests, 20 context-audit tests - all passed
- Learning: TDD approach allows us to now fix context-audit detection issues
  with confidence that tests will catch regressions.

## Iteration 11 - US-121: Fix context-audit monorepo detection
- Model: opus
- Fixed monorepo detection in context-audit skill (audit.sh):
  - Added helper function check_pkg_for_dep() for POSIX-safe dependency checking
  - Now searches packages/*/package.json and apps/*/package.json for dependencies
  - Uses `find` command with fallback for graceful handling of missing directories
  - React Native/Expo detection uses POSIX-safe separate checks instead of grep alternation
  - UI Components detection now checks packages/ui-web and packages/ui-native patterns
- Tested on domica project: correctly detects:
  - Next.js (found in apps/admin/package.json)
  - React Native/Expo (found in packages/ui-native/package.json)
  - Supabase (found supabase/)
  - RTL (found Hebrew/Arabic patterns)
  - UI Components (found packages/ui-web)
- CodeRabbit: Found one issue (grep alternation not POSIX-safe) - fixed
- Tests: 205 zsh tests, 20 context-audit tests - all passed
- Learning: Monorepo detection requires checking nested package.json files,
  not just root. The `find` command is more reliable than glob patterns for this.

## Iteration 12 - US-122: Update contexts/README.md with dogfooding docs
- Model: opus
- Updated contexts/README.md with new sections explaining the context system philosophy:
  - Added "Dogfooding Requirement" section: projects defining contexts MUST use them
  - Added "Cross-Project Improvement" section with diagram showing how one fix benefits all projects
  - Added "Self-Improvement Loop" section with workflow diagram: find gap -> create story -> Ralph fixes
  - Added context-audit workflow example showing expected output
  - Updated "How to Reference Contexts" with current @context: syntax (standard, with descriptions, naming conventions)
  - Added "Legacy Syntax (Deprecated)" for backward compatibility info
- CodeRabbit: Rate limited, skipped (tests pass comprehensively)
- Tests: 205 zsh tests, 17 skills tests, 83 TypeScript tests - all passed
- Learning: The ASCII art diagrams help visualize how contexts propagate across projects
  and the self-improvement feedback loop. Important for onboarding new users.

## Iteration 13 - US-123: Update SETUP.md and ralph-install quickguide
- Model: opus
- Updated SETUP.md with comprehensive documentation for wiring new projects:
  - Step 3 now includes contexts setup (3a: skills symlink, 3b: contexts installation)
  - Added new "Wiring a New Project" section with step-by-step guide
  - Registry.json schema explained with required/optional fields
  - Context selection table matching tech stack to recommended contexts
  - Complete example for Next.js + Supabase project
  - Updated Summary Checklist to include contexts and wiring
- Updated ralph-install/SKILL.md Quick Start table to include wire-project workflow
- Created new workflow: ralph-install/workflows/wire-project.md with:
  - Context-audit integration for auto-detecting tech stack
  - Detailed registry entry configuration
  - MCP configuration with secrets using 1Password op:// references
  - Troubleshooting section for common wiring issues
- CodeRabbit: Rate limited, skipped (documentation-only story, tests pass)
- Tests: 205 zsh tests passed
- Learning: The wiring documentation now provides a complete path from install to
  project-specific Claude sessions with appropriate contexts and MCPs.

## Iteration 14 - US-124: TDD: Create test-prd-manager.sh
- Model: opus
- Created comprehensive test suite for prd-manager skill:
  - tests/test-prd-manager.sh with 22 passing tests + 1 expected failure
  - tests/fixtures/prd-manager/generate-fixtures.sh for scenario generation
- Test coverage includes:
  - list action: pending/blocked/all scopes, empty list
  - show action: story details, missing story error, missing --story error
  - stats action: correct counts, blocked stories, empty PRD
  - check-progress: next story, criteria, stats, COMPLETE state
  - add-criterion: single story, bulk scope, idempotency
  - add-to-index: adds to index, missing file error
  - set-next: updates nextStory
  - summary action (expected failure - not implemented yet)
  - help/usage output
- Fixture scenarios: basic, empty, blocked, all-completed
- Fixed bash portability issues in prd-manager/scripts/run.sh:
  - Replaced ${SCOPE^^} with $(echo "$SCOPE" | tr '[:lower:]' '[:upper:]')
  - Replaced mapfile with portable while read loop
  - Fixed bulk update counting with temp file approach (per CodeRabbit)
- CodeRabbit: Found counting logic issue - fixed using temp file pattern
- Tests: 205 zsh tests, 22 prd-manager tests - all passed
- Learning: The test suite follows TDD pattern from test-context-audit.sh.
  Summary action test is intentionally expected to fail (US-125 will implement it).

## Iteration 15 - US-125: Implement prd-manager --action=summary
- Model: opus
- Added summary action to prd-manager/scripts/run.sh:
  - Shows completed stories (passes=true) in a formatted table
  - Columns: ID, TITLE (truncated to 35 chars), COMPLETED (datetime), BY (completedBy)
  - Shows total completed count at the bottom
  - Shows time range (first completion to last completion)
  - ISO datetime formatting strips seconds for cleaner display
- Updated help output to include --action=summary
- Tests: 205 zsh tests, 23 prd-manager tests (summary test now passes)
- CodeRabbit: Rate limited, skipped (tests pass comprehensively)
- Learning: The summary action completes the TDD cycle started in US-124.
  Tests written first, implementation verified by tests passing.

## Iteration 16 - US-126: Make README.md AI-friendly
- Model: opus
- Added "For AI Assistants" section at the top of README.md with:
  - Clear explanation that this is a self-improving toolkit for Claude Code
  - Skills library overview (/golem-powers:*)
  - Quick-start for setup: /golem-powers:ralph-install
  - Context verification command: /golem-powers:context-audit
  - Key directories table with links to skills/, contexts/, prompts/, lib/
  - Self-improvement loop explanation: find gap → create PRD → Ralph fixes
  - Link to contexts/README.md for full context system documentation
- Goal: Any AI given the repo link can immediately understand:
  - What the toolkit does
  - How to help users set it up
  - How to verify setup is correct
  - Where to find skills and contexts
- CodeRabbit: Rate limited, skipped (205 zsh tests, 274 TypeScript tests all pass)
- Tests: All tests pass
- Learning: An AI-friendly README section makes onboarding faster for both AIs and humans.

## Iteration 17 - MP-127: Deep exploration & documentation of golem system
- Model: opus
- Completed the documentation creation for the golem system:
  - Created contexts/golem-system.md explaining golem + zikaron philosophy
    - Documents core principles: death/rebirth, single source of truth, incremental progress
    - Explains Zikaron memory system and learning workflow
    - Details story types and model routing
    - Includes PRD system lifecycle diagrams
    - Covers key design decisions and anti-patterns
  - Created docs/architecture.md with detailed component documentation
    - Full directory structure breakdown
    - Component details for ralph.zsh, lib/*.zsh, bun/core/, skills
    - Data flow diagrams for iteration lifecycle and story state machine
    - Configuration schema documentation
    - Extension points for adding skills, contexts, models, story types
  - Created docs/architecture-map.md with ASCII visual diagrams
    - System overview showing all layers
    - Iteration flow diagram
    - Story state flow
    - Model routing decision tree
    - Context system architecture
    - Skills invocation architecture
    - Cost tracking flow
  - Updated contexts/README.md to add golem-system to available contexts table
  - Added golem-system to golem project contexts in registry.json
- CodeRabbit: Rate limited, skipped (205 zsh tests, 17 skills tests, 83 TypeScript tests all pass)
- Tests: All tests pass
- Learning: The golem-system context provides comprehensive documentation of the system
  philosophy and architecture, helping new contributors understand the "why" behind design decisions.

## Iteration 18 - US-128: Research 1Password Environments + document CLI integration patterns
- Model: opus
- Researched 1Password Environments (Beta) feature from official documentation
- Key insight: Environments are created in the 1Password desktop app UI (not automatable via CLI),
  but once created, CLI can access secrets via:
  - Named pipe mounts (local .env file destination)
  - op run (environment variables)
  - op inject (config file templating)
- Created workflows/use-environment.md with:
  - Named pipe architecture diagram showing how secrets flow from 1Password to apps
  - Step-by-step setup instructions (one-time in desktop app)
  - Comparison tables: Environments vs CLI, mounted .env vs op inject
  - ralphtools configuration example
  - Troubleshooting section
- Updated SKILL.md with enhanced Environments section:
  - ASCII diagram showing UI creation + CLI access workflow
  - When to use Environments vs CLI decision table
  - Code examples for mounted .env, op inject, and op run
  - Updated limitations table (Mac/Linux only, 10 max mounts, etc.)
- Added use-environment workflow to Quick Actions table
- Updated Decision Tree to prioritize Environments for project setup
- CodeRabbit: Rate limited, skipped (205 zsh tests, 17 skills tests, 274 TypeScript tests all pass)
- Tests: All tests pass
- Learning: 1Password Environments is the preferred method for local development secrets because
  secrets never touch disk (named pipe), but CLI (op run/inject) is still needed for CI/CD pipelines
  where environments cannot be created programmatically.
