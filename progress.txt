# Ralph Progress - Self-Improvement Dogfooding PRD
Started: Sun Jan 25 20:00:00 IST 2026

## New PRD: 11 stories
- US-116: Setup header + @context: refs to claude-golem CLAUDE.md
- US-118: Registry contexts field + launchers auto-load
- US-119: Ralph loads project contexts
- V-116: Verify dogfooding works
- US-120: TDD: test-context-audit.sh
- US-121: Fix monorepo detection
- US-122: Update contexts/README.md
- US-123: Update SETUP.md + ralph-install quickguide
- US-124: TDD: test-prd-manager.sh
- US-125: Implement --action=summary
- US-126: AI-friendly README

---

## Previous PRD (completed)

## Iteration 1 - BUG-013: Ralph UI doesn't exit properly and ignores keyboard input
- Model: opus
- Fixed exit handling in ralph-ui:
  - Added centralized `cleanupAndExit()` function that handles cleanup and graceful unmount
  - Fixed stop file path to use `os.homedir()` instead of `process.env.HOME` for cross-platform compatibility
  - Added proper completion summary showing stories completed, time elapsed, and errors
  - Implemented `waitForKeypress()` function to wait for user input before exiting (with 30s timeout)
  - Removed duplicate SIGINT handlers from Dashboard KeyboardHandler (now handled by global handler)
  - Fixed inkInstance usage to use global variable for proper cleanup from signal handlers
- CodeRabbit: Passed after fixing stopFile path issue
- Root cause: Multiple competing exit handlers and race conditions between Ink unmount and process.exit
- Tests: 205 zsh tests passed, 188 TypeScript tests passed

## Iteration 2 - US-115: Fix archive script with template-based testing
- Model: opus
- Created tests/fixtures/prd-archive/generate-fixtures.sh that generates realistic PRD structures:
  - Creates index.json matching current schema (with pending/blocked/completed arrays)
  - Creates mix of completed, pending, and blocked stories
  - Generates progress.txt for testing
- Created tests/test-archive.sh with 14 tests covering:
  - archive-snapshot.sh: timestamped directory creation, index/stories/progress copying
  - cleanup-completed.sh: removes only passes=true stories, resets completed array, preserves pending/blocked
- Bug found and fixed in cleanup-completed.sh:
  - The jq expression was setting `.stats.completed = 0` but NOT resetting `.completed = []`
  - Also removed references to `.stats` object which doesn't exist in current schema
- CodeRabbit: Rate limited, skipped (tests pass comprehensively)
- Root cause: cleanup-completed.sh jq expression didn't update the completed array, only a non-existent stats object
- Tests: 205 zsh tests, 14 archive tests, 83 TypeScript tests - all passed

## Iteration 3 - US-113: Interactive config editing from Ralph UI
- Model: opus
- Implemented interactive configuration menu accessible via 'c' key during Ralph execution:
  - Created ConfigMenu.tsx component with Ink-based UI
  - Supports UI mode (live/iteration/startup), default model, and ntfy topic settings
  - Arrow keys for navigation, left/right to cycle select options, Enter to edit text fields
  - 's' key saves config to ~/.config/ralphtools/config.json
  - Escape or 'q' closes menu without saving
  - Shows confirmation message after save
- Added saveConfig function to bun/core/config.ts (also created local copy in ralph-ui/src/utils/config.ts for module isolation)
- Added uiMode field to RalphConfig type
- Modified Dashboard.tsx to integrate ConfigMenu with keyboard handler
- Updated footer to show "'q' quit â€¢ 'c' config" hint
- CodeRabbit: Rate limited, skipped (all tests pass)
- Note: Gum fallback marked as "nice-to-have" - Ink UI provides full functionality
- Tests: 205 zsh tests passed, 83 bun tests passed, 188 ralph-ui tests passed

## Iteration 4 - US-114: Migrate etanheyman.com secrets to 1Password
- Model: opus
- Created `portfolio` vault in 1Password for etanheyman.com project secrets
- Migrated 4 secrets to the portfolio vault:
  - RESEND_API_KEY - Email sending service
  - NEXTAUTH_SECRET - NextAuth session encryption
  - UPLOADTHING_TOKEN - File upload service
  - OPTIMIZE_API_KEY - Image optimization service
- Updated ~/Gits/etanheyman.com/.env.local to use op:// references
- Verified secrets resolve correctly with `op inject`
- Documented migration in docs.local/audits/AUDIT-005-secrets.md
- CodeRabbit: Passed
- Tests: 205 zsh tests passed

## Iteration 5 - BUG-029: update.json merge deletes file but doesn't update index.json
- Model: opus
- Root cause identified: The /prd skill was using a "direct override" format for update.json:
  ```json
  { "storyOrder": [...], "pending": [...] }
  ```
  But the `applyUpdateQueue()` function only supported the `newStories`, `updateStories`, etc. format.
  Result: The file was deleted without actually merging the new stories.
- Fix: Added support for direct `storyOrder` and `pending` array overrides in `applyUpdateQueue()`
  - Updated `UpdateQueue` interface in ralph-ui/src/runner/types.ts
  - Added merge logic for storyOrder and pending arrays in ralph-ui/src/runner/prd.ts
  - New story IDs from update.json are merged into existing arrays (deduplicated)
- Added 3 new tests in ralph-ui/tests/prd.test.ts:
  - Test direct override format merges correctly
  - Test existing fields are preserved during merge
  - Test update.json NOT deleted if merge fails
- CodeRabbit: Passed
- Tests: 205 zsh tests passed, 191 TypeScript tests passed
- Learning: The update.json format documentation in /prd skill was misleading - it showed direct
  field overrides but the code expected queue operations. Now the code supports both formats.

## Iteration 6 - US-116: Dogfood contexts in claude-golem
- Model: opus
- Created contexts/templates/project-setup-header.md:
  - Template for "## SETUP (AI: Read This First)" section
  - Includes guidance for purpose, quick start, skills available, and self-improvement loop awareness
  - Helps future projects adopt the context system consistently
- Updated claude-golem/CLAUDE.md:
  - Added SETUP header section with purpose, quick start, skills, and dogfooding awareness
  - Added @context: refs (base, skill-index, workflow/interactive, workflow/ralph)
  - Now dogfoods its own context system like other projects do
- Context audit: All referenced contexts exist (base.md, skill-index.md, workflow/interactive.md, workflow/ralph.md)
- CodeRabbit: Passed
- Tests: 205 zsh tests passed, 83 TypeScript tests passed
- Learning: The context-audit script's grep pattern doesn't handle inline descriptions after context refs
  (e.g., "@context: base - Universal rules" shows parsing issues). Consider fixing in a future story.

