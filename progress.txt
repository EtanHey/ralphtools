# Ralph Progress - v2 Skills + Bug Fixes

Started: Fri Jan 23 14:56:32 IST 2026

## Iteration 1 - US-032: Skills Discovery command (/skills)
**Status**: COMPLETED

Created `/skills` command that:
- Scans ~/.claude/commands/ for all installed skills
- Detects both single-file (.md) and multi-file (SKILL.md) formats
- Extracts descriptions from YAML frontmatter or first blockquote
- Groups skills by category (Infrastructure, Domain, Custom)
- Shows skill source (ralphtools, superpowers, ralph-config, custom)
- Counts workflows for progressive disclosure skills
- Supports --search keyword filtering

Files created:
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/skills.md
- Symlinked to ~/.claude/commands/skills.md

### Learnings
- Skills use YAML frontmatter with `name` and `description` fields
- Multi-file skills have SKILL.md at root with workflows/ subdirectory
- Source detection via symlink resolution (readlink -f)

## Iteration 2 - US-033: Linear skill (API wrapper)
**Status**: COMPLETED

Created `/linear` skill that replaces the need for Linear MCP:
- Uses curl with Linear's GraphQL API (https://api.linear.app/graphql)
- API key stored in 1Password, retrieved via `op read`
- Progressive disclosure architecture: SKILL.md router + 4 workflow files

Files created:
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/linear/SKILL.md - Router with quick actions table
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/linear/workflows/create-issue.md - Create issues with priority, labels, assignee
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/linear/workflows/list-issues.md - Query/filter/search issues
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/linear/workflows/update-issue.md - Update state, assignee, priority, add comments
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/linear/workflows/create-worktree.md - Create git worktree from Linear issue
- Symlinked to ~/.claude/commands/linear

### Learnings
- Linear API uses GraphQL at https://api.linear.app/graphql
- Auth: `Authorization: <API_KEY>` (no Bearer prefix for API keys)
- Linear auto-generates branch names for issues via `branchName` field
- Rate limit: 1,500 requests/hour with API key auth
- GraphQL returns 200 even on errors - always check `errors` array

## Iteration 3 - US-034: Convex skill (CLI wrapper)
**Status**: COMPLETED

Created `/convex` skill that wraps the npx convex CLI:
- Progressive disclosure architecture: SKILL.md router + 6 workflow files
- Auto-detects Convex project by checking for `convex/` directory
- Handles CONVEX_DEPLOY_KEY from 1Password for CI/CD production deploys

Files created:
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/SKILL.md - Router with quick actions table
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/workflows/dev.md - Start dev server with hot reload
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/workflows/deploy.md - Production deployment with deploy key
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/workflows/run-function.md - Execute queries, mutations, actions
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/workflows/data-export.md - Export database to zip
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/workflows/data-import.md - Import data with safety warnings
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/workflows/schema.md - Schema inspection and validation
- Symlinked to ~/.claude/commands/convex

### Learnings
- Convex CLI commands: dev, deploy, run, export, import, codegen, env, dashboard
- Deploy key format: `prod:...` for production access
- Function path format: `filename:functionName` (no .ts extension)
- Always backup before import - import can overwrite data
- Schema changes can be destructive - export first

## Iteration 4 - US-036: Install Wizard skill
**Status**: COMPLETED

Created `/ralph-install` skill that guides new users through ralphtools setup:
- Progressive disclosure architecture: SKILL.md router + 5 workflow files
- Checks for all required CLIs (gh, op, gum, fswatch, jq, git)
- Guides brew installation of missing dependencies
- Helps configure API tokens in 1Password
- Creates skill symlinks in ~/.claude/commands/
- Validates entire installation end-to-end

Files created:
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/ralph-install/SKILL.md - Router with workflow table and troubleshooting
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/ralph-install/workflows/check-deps.md - Dependency verification scripts
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/ralph-install/workflows/install-deps.md - Homebrew installation guide
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/ralph-install/workflows/setup-tokens.md - 1Password token configuration
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/ralph-install/workflows/setup-symlinks.md - Skill symlink creation
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/ralph-install/workflows/validate.md - Post-install validation
- Symlinked to ~/.claude/commands/ralph-install

### Learnings
- Install wizards benefit from step-by-step workflow separation
- Include troubleshooting in main SKILL.md for quick reference
- Validation scripts with pass/fail counts give clear status

## Iteration 5 - US-037: Separate notification channels (Ralph vs Claude)
**Status**: COMPLETED

Implemented separate ntfy topics for Ralph and Claude:
- Ralph topics are per-project: `etans-ralph-<project>` (same project shares topic)
- Claude topic is fixed: `etans-ralphClaude` (never mixes with Ralph)
- Added configurable prefix via RALPH_NTFY_PREFIX
- All Ralph notifications now include [Ralph] prefix in title

Files modified:
- /Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh - Updated defaults and notification function
- /Users/etanheyman/Desktop/Gits/ralphtools/docs/notifications.md - Created topic naming documentation

### Learnings
- Per-project topics allow subscribing only to active projects
- Fixed Claude topic ensures Claude alerts are never buried in Ralph iterations
- [Ralph] prefix in title makes notifications easily identifiable at a glance

## Iteration 6 - US-038: Session isolation via git worktree
**Status**: COMPLETED

Implemented worktree-based session isolation to keep Ralph from polluting main project's Claude /resume history:

Commands added:
- `ralph-start [args]` - Creates worktree at ~/worktrees/<repo>/ralph-session, outputs cd + ralph command
- `ralph-cleanup [--force]` - Merges changes back to main repo, removes worktree

How it works:
- Claude sessions are stored per-directory in ~/.claude/projects/
- Each directory path gets its own session storage
- Git worktrees create a linked copy at a different path
- Claude sees worktree as a separate project → separate session history
- `/resume` in main project stays clean (no Ralph iterations)

Files created/modified:
- /Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh - Added ralph-start, ralph-cleanup, _ralph_output_worktree_command
- /Users/etanheyman/Desktop/Gits/ralphtools/docs/session-isolation.md - Full documentation
- /Users/etanheyman/Desktop/Gits/ralphtools/prd-json/AGENTS.md - Added worktree workflow section

### Learnings
- Claude sessions stored in ~/.claude/projects/ with path encoded (dashes replace slashes)
- Worktrees at different paths get completely separate session histories
- Must copy prd-json/ and progress.txt to worktree for Ralph to work
- ralph-cleanup syncs state back before removing worktree
- git worktree prune cleans up stale references

## Iteration 7 - US-039: UI guards (prevent 104%, fix cost alignment)
**Status**: COMPLETED

Fixed UI display bugs to prevent impossible values:
- Progress percentage now capped at 100% max
- Stats sanity check: completed capped at total (handles 49/47 → 47/47 case)
- Warning log written to RALPH_LOG_FILE when stats are inconsistent
- Fixed cost box right-side alignment using consistent BOX_INNER_WIDTH=61
- Replaced complex padding formula with simpler `(BOX_INNER_WIDTH - display_width)`

Files modified:
- /Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh
  - `_ralph_progress_bar()`: Added `(( percent > 100 )) && percent=100`
  - `_ralph_draw_progress_line()`: Added sanity check for completed > total
  - `_ralph_show_prd_json()`: Added sanity check for completed > total
  - Multiple box drawing sections: Fixed padding formula to use consistent BOX_INNER_WIDTH

### Learnings
- Box drawing: 65-char wide box = 61-char inner content (between `│  ` and `│`)
- Padding formula should be `(BOX_INNER_WIDTH - display_width)` not complex subtraction
- Always cap percentages defensively even if input should be valid
- Log warnings for data inconsistencies to help debug root causes

## Iteration 8 - US-040: 1Password detection fix (check actual config)
**Status**: COMPLETED

Fixed 1Password status display to accurately reflect whether 1Password Environments are configured:

Problem:
- Previously showed "Available (secrets via 1Password Environments)" just because op CLI was installed
- User hadn't actually configured 1Password Environments for the project

Solution:
- Added `_ralph_check_op_environments()` function that checks for actual configuration:
  - Looks for `.env.1password` file
  - Checks for `op://` references in `.env`, `.env.local`, `.env.development`, etc.
  - Checks for `op://` references in `package.json`
- Updated status display in main `ralph` function to show three states:
  1. "Available (secrets via 1Password Environments)" - CLI + signed in + configured
  2. "CLI available (environments not configured)" - CLI + signed in but no op:// refs
  3. "CLI available but not signed in" - CLI installed but not authenticated
  4. "Not installed (using environment variables)" - no op CLI
- Added new "Configure 1Password Environments" option to `ralph-setup` wizard
- Created `_ralph_setup_configure_op_environments()` helper function

Files modified:
- /Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh
  - Added `_ralph_check_op_environments()` global function (lines 4703-4729)
  - Updated main ralph function 1Password status display (lines 2441-2457)
  - Updated ralph-setup wizard status display (lines 5346-5380)
  - Added new menu option "Configure 1Password Environments" (lines 5385-5430)
  - Added `_ralph_setup_configure_op_environments()` helper (lines 5711-5812)

### Learnings
- 1Password Environments use `op://` reference format: `op://vault/item/field`
- Common patterns: `.env.1password` file or `op://` refs in `.env*` files
- Status display should reflect actual configuration state, not just tool presence
- Configuration guidance should be actionable with specific commands

## Iteration 9 - US-041: Enhanced archive skill with cleanup option
**Status**: COMPLETED

Upgraded the archive skill from a single-file knowledge skill to a full progressive disclosure structure with bash functions:

### Skill Structure Created
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/archive/SKILL.md` - Main router with quick actions table
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/archive/workflows/archive-snapshot.md` - Timestamped archive workflow
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/archive/workflows/cleanup-completed.md` - Cleanup and reset workflow
- Removed old `skills/archive.md` single-file skill
- Updated symlink: `~/.claude/commands/archive` now points to directory

### New Features in ralph-archive
- `--keep` flag: Archive only, skip cleanup prompt
- `--clean` flag: Archive and auto-cleanup without prompt
- (no flag): Interactive prompt using `gum confirm` (fallback to `read -q`)
- Archives `progress.txt` alongside PRD files
- Creates fresh `progress.txt` after cleanup with "Fresh Start" header
- Proper stats reset: completed=0, recalculates total from remaining stories
- Preserves blocked array when rebuilding pending

### Functions Modified
- `ralph-archive()` - Added flag parsing loop (lines 3882-3928)
- `_ralph_archive_json()` - Added mode parameter, gum confirm support (lines 3930-3989)
- `_ralph_archive_cleanup()` - New function for cleanup logic (lines 3991-4086)
- `_ralph_archive_md()` - Updated with mode parameter for consistency (lines 4088-4169)

### Tests Added (6 new tests)
- `test_archive_parses_keep_flag` - Verifies --keep flag parsing
- `test_archive_parses_clean_flag` - Verifies --clean flag and story removal
- `test_archive_copies_progress_txt` - Verifies progress.txt archiving
- `test_archive_cleanup_creates_fresh_progress` - Verifies fresh progress.txt
- `test_archive_cleanup_resets_stats` - Verifies index.json stats reset
- `test_archive_rejects_unknown_flags` - Verifies error on invalid flags

### Learnings
- `gum confirm` defaults to "No" with `--default=false`
- ZSH arrays are 1-indexed, so `${array[1]}` is first element
- When rebuilding index.json, preserve blocked array but rebuild pending from remaining files
- Archive first, then cleanup - ensures full history preservation
- Use `(N)` glob qualifier to handle empty directories gracefully

## Iteration 10 - US-042: Pre-commit hook runs tests
**Status**: COMPLETED

Added test suite execution to the pre-commit hook. Tests now run automatically on every commit, ensuring code quality is maintained.

### Changes Made
- `.githooks/pre-commit` - Added step 7 (Test Suite) that runs `tests/test-ralph.zsh`
- Restructured hook to run tests for ALL commits (not just when .zsh files staged)
- Steps 1-5 (syntax checks) only run when .zsh files are staged
- Steps 6-8 (JSON validation, tests, AGENTS.md sync) always run
- Updated all step numbers from 7 to 8 total

### Files Modified
- `/Users/etanheyman/Desktop/Gits/ralphtools/.githooks/pre-commit` - Added test suite section
- `/Users/etanheyman/Desktop/Gits/ralphtools/scripts/setup-hooks.sh` - Updated summary to mention test suite
- `/Users/etanheyman/Desktop/Gits/ralphtools/CLAUDE.md` - Added pre-commit test hook documentation

### Learnings
- Pre-commit hooks should run tests for ALL commits, not just code changes
- Tests ensure any config/schema changes don't break functionality
- Execution time: ~1 second total (35 tests + all checks)
- `--no-verify` is built-in git feature for bypassing hooks

## Iteration 11 - BUG-003: fswatch background job outputs TTY noise
**Status**: COMPLETED

Fixed the fswatch background job to stop outputting job control messages like `[4] 73252` and `suspended (tty output)`.

### Root Cause
When ZSH starts a background job with `(...)&`, it outputs job control messages. Additionally, background processes trying to write to stdout can trigger "suspended (tty output)" messages.

### Solution
1. Added `setopt LOCAL_OPTIONS NO_MONITOR NO_NOTIFY` before starting the background job
2. Changed from `(...)&` to `{...} </dev/null >/dev/null 2>&1 &` to detach from TTY
3. Used ZSH coproc to start fswatch/inotifywait and capture its PID
4. Stored fswatch PID in `/tmp/ralph_watcher_$$_pid` for precise cleanup
5. Updated `_ralph_stop_watcher()` to kill both the wrapper shell and the actual fswatch process

### Files Modified
- `/Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh`
  - `_ralph_start_watcher()`: Added TTY detachment, coproc usage, PID file creation
  - `_ralph_stop_watcher()`: Added PID file-based cleanup for precise process termination

### Learnings
- `setopt NO_MONITOR NO_NOTIFY` suppresses ZSH job control output
- `&!` disowns immediately but doesn't capture PID in `$!`; use `& ; disown` instead
- Pipelines in backgrounded braces need special handling - `coproc` provides cleaner PID capture
- FIFO writes inside subshells with redirected outer stdout still work because they use explicit file paths
- When using `disown`, `wait` won't work on the process, so kill and brief sleep is sufficient

## Iteration 12 - US-035: Worktrees skill (task isolation)
**Status**: COMPLETED

Created `/worktrees` skill for git worktree-based task isolation. Enables creating isolated working directories for each task, preventing cross-contamination between branches.

### Skill Structure Created
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/worktrees/SKILL.md` - Router with quick actions table
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/worktrees/workflows/create.md` - Create worktree from branch name
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/worktrees/workflows/list.md` - List active worktrees
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/worktrees/workflows/switch.md` - Navigate between worktrees
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/worktrees/workflows/cleanup.md` - Remove completed worktrees
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/worktrees/workflows/from-linear.md` - Create worktree from Linear issue
- Symlinked to ~/.claude/commands/worktrees

### Features
- Default path: `~/worktrees/<repo>/<branch>`
- Linear integration: Auto-generates branch names from Linear issues (branchName field)
- Custom branch naming options: feature/ENG-123-description, fix/ENG-456-description
- Interactive selection with gum integration
- Shell function (`wt`) for quick switching with fuzzy matching
- Safe cleanup workflow with merge verification
- VS Code/Cursor integration instructions

### Learnings
- Linear issues have `branchName` field with auto-sanitized branch names
- `git worktree add <path> -b <branch>` creates worktree with new branch
- `git worktree remove <path>` removes worktree and cleans git references
- `git worktree prune` cleans up stale references from deleted directories
- Skills that are purely markdown (no standalone scripts) don't need zsh typecheck
