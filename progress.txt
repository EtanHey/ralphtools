# Ralph Progress - ralphtools v1.4 Implementation

## Project
- Repo: ~/Desktop/Gits/ralphtools
- PRD: prd-json/

## Learnings
- zsh subshells don't share global variables with parent - use temp files for result tracking

---

## Iterations

## Iteration 1 - TEST-001 Test Framework
- Model: opus
- Created tests/test-ralph.zsh with full zsh test framework
- Added assertion helpers: assert_equals, assert_contains, assert_exit_code, assert_not_empty, assert_file_exists
- Added test output functions: test_start, test_pass, test_fail
- Implemented file-based result tracking for reliable pass/fail counts
- Test runner discovers and runs all test_* functions
- Summary shows "X passed, Y failed" at end
- Exit code 0 on success, 1 on failure
- zsh -n syntax check passes
- Framework includes 5 self-validation tests that all pass
---

## Iteration 2 - TEST-002 Config Function Tests
- Model: opus
- Added comprehensive unit tests for config loading and model routing
- test_config_load_valid: Tests loading a valid config.json with all model mappings
- test_config_load_missing_file: Tests return code 1 when config file missing
- test_config_load_malformed_json: Tests graceful handling of invalid JSON
- test_model_routing_us/v/test/bug/audit: Tests each prefix routes to correct model
- test_model_routing_unknown: Tests unknown prefix uses fallback model
- test_model_routing_cli_override: Tests CLI flags override config settings
- test_model_routing_single_strategy: Tests single mode uses default for all
- All 16 tests pass (11 new config tests + 5 framework validation tests)
- Typecheck passes (zsh -n)
---

## Iteration 3 - TEST-003 Cost Tracking Tests
- Model: opus
- Added 7 comprehensive unit tests for cost tracking functions
- test_init_costs_creates_valid_structure: Verifies costs.json has runs, totals, avgTokensObserved keys
- test_log_cost_adds_entry: Tests entry creation with storyId, model, prefix, status fields
- test_cost_calculation_with_duration: Verifies input/output tokens calculated from duration (60s = 60000↓, 30000↑)
- test_haiku_pricing: Confirms haiku rates $1/M input, $5/M output → 100s = $0.35
- test_sonnet_pricing: Confirms sonnet rates $3/M input, $15/M output → 100s = $1.05
- test_opus_pricing: Confirms opus rates $15/M input, $75/M output → 100s = $5.25
- test_get_session_tokens_missing_session: Verifies "0 0 0 0" returned for missing session
- Fixed test file to use local repo ralph.zsh instead of only checking installed location
- Renamed `status` to `run_status` to avoid zsh reserved variable conflict
- All 23 tests pass (7 new cost tracking + 11 config + 5 framework)
- Typecheck passes (zsh -n)
---

## Iteration 4 - TEST-004 Notification Function Tests
- Model: opus
- Added 6 unit tests for ntfy notification functions
- Created _ralph_ntfy_testable function that mirrors _ralph_ntfy but allows mocking curl
- test_ntfy_builds_body_with_project_name: Verifies body includes project folder, iteration, story_id, model, remaining, cost, message
- test_ntfy_event_types_set_title_priority: Tests all event types (complete, blocked, error, iteration, max_iterations, unknown)
- test_ntfy_complete_priority_high: Confirms complete event uses priority=high
- test_ntfy_error_priority_urgent: Confirms error event uses priority=urgent
- test_ntfy_iteration_priority_low: Confirms iteration event uses priority=low
- test_ntfy_empty_topic_no_curl: Verifies empty topic returns early without calling curl
- All 29 tests pass (6 new notification + 7 cost + 11 config + 5 framework)
- Typecheck passes (zsh -n)
---

## Iteration 5 - TEST-005 GitHub Actions CI
- Model: opus
- Created .github/workflows/ci.yml for continuous integration
- Workflow triggers on push to master and all PRs
- Uses macos-latest runner for native zsh support
- Steps: checkout → install jq → syntax check → run tests
- Validated YAML syntax with python yaml.safe_load
- Verified syntax check passes locally (zsh -n ralph.zsh)
- Verified all 29 tests pass locally
- CI will now automatically run tests on every PR and push to master
---

## Iteration 6 - US-001 Add Gum Dependency Check
- Model: opus
- Added _ralph_check_gum() function to check if gum CLI is installed
- Function outputs "For interactive setup, install gum: brew install gum" when gum is missing
- Returns 0 if gum available, 1 if not (standard shell convention)
- Added RALPH_HAS_GUM variable that gets set on script source (0=available, 1=missing)
- Placed in new GUM DEPENDENCY CHECK section after CONFIGURATION
- Typecheck passes (zsh -n ralph.zsh)
---

## Iteration 7 - US-002 Create ralph config interactive flow
- Model: opus
- Implemented ralph-config() function for interactive configuration setup
- GUM MODE: Uses gum choose for model strategy (smart/single) and default model (opus/sonnet/haiku)
- GUM MODE: Uses gum confirm for notifications toggle, gum input for ntfy topic
- FALLBACK MODE: Simple numbered prompts with read when gum not installed
- Saves configuration to ~/.config/ralphtools/config.json with proper JSON structure
- Config includes: modelStrategy, defaultModel, models per-prefix routing, notifications settings, defaults
- Reloads config after save with _ralph_load_config
- Shows confirmation with current settings using _ralph_show_routing
- New INTERACTIVE CONFIGURATION section added between GUM DEPENDENCY CHECK and SMART MODEL ROUTING
- Typecheck passes (zsh -n ralph.zsh)
---

## Iteration 8 - US-003 First-run detection and setup prompt
- Model: opus
- Added _ralph_first_run_check() function in new FIRST-RUN DETECTION section
- Detects missing config.json and shows welcome banner: "Welcome to Ralph!"
- Supports --skip-setup / -y flag to use defaults without interactive prompts
- Creates minimal config.json with sensible defaults (smart routing, sonnet default, notifications off)
- GUM mode: Uses gum confirm to ask if user wants interactive setup
- Fallback mode: Numbered menu (1=setup, 2=defaults) using read
- Calls ralph-config if user accepts interactive setup
- Integrated check into main ralph() function right after argument parsing, before loop starts
- Added skip_setup local variable and --skip-setup/-y flag parsing in ralph()
- Typecheck passes (zsh -n ralph.zsh)
---
