# Ralph Progress - v2 Skills + Bug Fixes

Started: Fri Jan 23 14:56:32 IST 2026

## Iteration 1 - US-032: Skills Discovery command (/skills)
**Status**: COMPLETED

Created `/skills` command that:
- Scans ~/.claude/commands/ for all installed skills
- Detects both single-file (.md) and multi-file (SKILL.md) formats
- Extracts descriptions from YAML frontmatter or first blockquote
- Groups skills by category (Infrastructure, Domain, Custom)
- Shows skill source (ralphtools, superpowers, ralph-config, custom)
- Counts workflows for progressive disclosure skills
- Supports --search keyword filtering

Files created:
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/skills.md
- Symlinked to ~/.claude/commands/skills.md

### Learnings
- Skills use YAML frontmatter with `name` and `description` fields
- Multi-file skills have SKILL.md at root with workflows/ subdirectory
- Source detection via symlink resolution (readlink -f)

## Iteration 2 - US-033: Linear skill (API wrapper)
**Status**: COMPLETED

Created `/linear` skill that replaces the need for Linear MCP:
- Uses curl with Linear's GraphQL API (https://api.linear.app/graphql)
- API key stored in 1Password, retrieved via `op read`
- Progressive disclosure architecture: SKILL.md router + 4 workflow files

Files created:
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/linear/SKILL.md - Router with quick actions table
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/linear/workflows/create-issue.md - Create issues with priority, labels, assignee
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/linear/workflows/list-issues.md - Query/filter/search issues
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/linear/workflows/update-issue.md - Update state, assignee, priority, add comments
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/linear/workflows/create-worktree.md - Create git worktree from Linear issue
- Symlinked to ~/.claude/commands/linear

### Learnings
- Linear API uses GraphQL at https://api.linear.app/graphql
- Auth: `Authorization: <API_KEY>` (no Bearer prefix for API keys)
- Linear auto-generates branch names for issues via `branchName` field
- Rate limit: 1,500 requests/hour with API key auth
- GraphQL returns 200 even on errors - always check `errors` array

## Iteration 3 - US-034: Convex skill (CLI wrapper)
**Status**: COMPLETED

Created `/convex` skill that wraps the npx convex CLI:
- Progressive disclosure architecture: SKILL.md router + 6 workflow files
- Auto-detects Convex project by checking for `convex/` directory
- Handles CONVEX_DEPLOY_KEY from 1Password for CI/CD production deploys

Files created:
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/SKILL.md - Router with quick actions table
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/workflows/dev.md - Start dev server with hot reload
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/workflows/deploy.md - Production deployment with deploy key
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/workflows/run-function.md - Execute queries, mutations, actions
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/workflows/data-export.md - Export database to zip
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/workflows/data-import.md - Import data with safety warnings
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/convex/workflows/schema.md - Schema inspection and validation
- Symlinked to ~/.claude/commands/convex

### Learnings
- Convex CLI commands: dev, deploy, run, export, import, codegen, env, dashboard
- Deploy key format: `prod:...` for production access
- Function path format: `filename:functionName` (no .ts extension)
- Always backup before import - import can overwrite data
- Schema changes can be destructive - export first

## Iteration 4 - US-036: Install Wizard skill
**Status**: COMPLETED

Created `/ralph-install` skill that guides new users through ralphtools setup:
- Progressive disclosure architecture: SKILL.md router + 5 workflow files
- Checks for all required CLIs (gh, op, gum, fswatch, jq, git)
- Guides brew installation of missing dependencies
- Helps configure API tokens in 1Password
- Creates skill symlinks in ~/.claude/commands/
- Validates entire installation end-to-end

Files created:
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/ralph-install/SKILL.md - Router with workflow table and troubleshooting
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/ralph-install/workflows/check-deps.md - Dependency verification scripts
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/ralph-install/workflows/install-deps.md - Homebrew installation guide
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/ralph-install/workflows/setup-tokens.md - 1Password token configuration
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/ralph-install/workflows/setup-symlinks.md - Skill symlink creation
- /Users/etanheyman/Desktop/Gits/ralphtools/skills/ralph-install/workflows/validate.md - Post-install validation
- Symlinked to ~/.claude/commands/ralph-install

### Learnings
- Install wizards benefit from step-by-step workflow separation
- Include troubleshooting in main SKILL.md for quick reference
- Validation scripts with pass/fail counts give clear status

## Iteration 5 - US-037: Separate notification channels (Ralph vs Claude)
**Status**: COMPLETED

Implemented separate ntfy topics for Ralph and Claude:
- Ralph topics are per-project: `etans-ralph-<project>` (same project shares topic)
- Claude topic is fixed: `etans-ralphClaude` (never mixes with Ralph)
- Added configurable prefix via RALPH_NTFY_PREFIX
- All Ralph notifications now include [Ralph] prefix in title

Files modified:
- /Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh - Updated defaults and notification function
- /Users/etanheyman/Desktop/Gits/ralphtools/docs/notifications.md - Created topic naming documentation

### Learnings
- Per-project topics allow subscribing only to active projects
- Fixed Claude topic ensures Claude alerts are never buried in Ralph iterations
- [Ralph] prefix in title makes notifications easily identifiable at a glance

## Iteration 6 - US-038: Session isolation via git worktree
**Status**: COMPLETED

Implemented worktree-based session isolation to keep Ralph from polluting main project's Claude /resume history:

Commands added:
- `ralph-start [args]` - Creates worktree at ~/worktrees/<repo>/ralph-session, outputs cd + ralph command
- `ralph-cleanup [--force]` - Merges changes back to main repo, removes worktree

How it works:
- Claude sessions are stored per-directory in ~/.claude/projects/
- Each directory path gets its own session storage
- Git worktrees create a linked copy at a different path
- Claude sees worktree as a separate project ‚Üí separate session history
- `/resume` in main project stays clean (no Ralph iterations)

Files created/modified:
- /Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh - Added ralph-start, ralph-cleanup, _ralph_output_worktree_command
- /Users/etanheyman/Desktop/Gits/ralphtools/docs/session-isolation.md - Full documentation
- /Users/etanheyman/Desktop/Gits/ralphtools/prd-json/AGENTS.md - Added worktree workflow section

### Learnings
- Claude sessions stored in ~/.claude/projects/ with path encoded (dashes replace slashes)
- Worktrees at different paths get completely separate session histories
- Must copy prd-json/ and progress.txt to worktree for Ralph to work
- ralph-cleanup syncs state back before removing worktree
- git worktree prune cleans up stale references

## Iteration 7 - US-039: UI guards (prevent 104%, fix cost alignment)
**Status**: COMPLETED

Fixed UI display bugs to prevent impossible values:
- Progress percentage now capped at 100% max
- Stats sanity check: completed capped at total (handles 49/47 ‚Üí 47/47 case)
- Warning log written to RALPH_LOG_FILE when stats are inconsistent
- Fixed cost box right-side alignment using consistent BOX_INNER_WIDTH=61
- Replaced complex padding formula with simpler `(BOX_INNER_WIDTH - display_width)`

Files modified:
- /Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh
  - `_ralph_progress_bar()`: Added `(( percent > 100 )) && percent=100`
  - `_ralph_draw_progress_line()`: Added sanity check for completed > total
  - `_ralph_show_prd_json()`: Added sanity check for completed > total
  - Multiple box drawing sections: Fixed padding formula to use consistent BOX_INNER_WIDTH

### Learnings
- Box drawing: 65-char wide box = 61-char inner content (between `‚îÇ  ` and `‚îÇ`)
- Padding formula should be `(BOX_INNER_WIDTH - display_width)` not complex subtraction
- Always cap percentages defensively even if input should be valid
- Log warnings for data inconsistencies to help debug root causes

## Iteration 8 - US-040: 1Password detection fix (check actual config)
**Status**: COMPLETED

Fixed 1Password status display to accurately reflect whether 1Password Environments are configured:

Problem:
- Previously showed "Available (secrets via 1Password Environments)" just because op CLI was installed
- User hadn't actually configured 1Password Environments for the project

Solution:
- Added `_ralph_check_op_environments()` function that checks for actual configuration:
  - Looks for `.env.1password` file
  - Checks for `op://` references in `.env`, `.env.local`, `.env.development`, etc.
  - Checks for `op://` references in `package.json`
- Updated status display in main `ralph` function to show three states:
  1. "Available (secrets via 1Password Environments)" - CLI + signed in + configured
  2. "CLI available (environments not configured)" - CLI + signed in but no op:// refs
  3. "CLI available but not signed in" - CLI installed but not authenticated
  4. "Not installed (using environment variables)" - no op CLI
- Added new "Configure 1Password Environments" option to `ralph-setup` wizard
- Created `_ralph_setup_configure_op_environments()` helper function

Files modified:
- /Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh
  - Added `_ralph_check_op_environments()` global function (lines 4703-4729)
  - Updated main ralph function 1Password status display (lines 2441-2457)
  - Updated ralph-setup wizard status display (lines 5346-5380)
  - Added new menu option "Configure 1Password Environments" (lines 5385-5430)
  - Added `_ralph_setup_configure_op_environments()` helper (lines 5711-5812)

### Learnings
- 1Password Environments use `op://` reference format: `op://vault/item/field`
- Common patterns: `.env.1password` file or `op://` refs in `.env*` files
- Status display should reflect actual configuration state, not just tool presence
- Configuration guidance should be actionable with specific commands

## Iteration 9 - US-041: Enhanced archive skill with cleanup option
**Status**: COMPLETED

Upgraded the archive skill from a single-file knowledge skill to a full progressive disclosure structure with bash functions:

### Skill Structure Created
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/archive/SKILL.md` - Main router with quick actions table
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/archive/workflows/archive-snapshot.md` - Timestamped archive workflow
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/archive/workflows/cleanup-completed.md` - Cleanup and reset workflow
- Removed old `skills/archive.md` single-file skill
- Updated symlink: `~/.claude/commands/archive` now points to directory

### New Features in ralph-archive
- `--keep` flag: Archive only, skip cleanup prompt
- `--clean` flag: Archive and auto-cleanup without prompt
- (no flag): Interactive prompt using `gum confirm` (fallback to `read -q`)
- Archives `progress.txt` alongside PRD files
- Creates fresh `progress.txt` after cleanup with "Fresh Start" header
- Proper stats reset: completed=0, recalculates total from remaining stories
- Preserves blocked array when rebuilding pending

### Functions Modified
- `ralph-archive()` - Added flag parsing loop (lines 3882-3928)
- `_ralph_archive_json()` - Added mode parameter, gum confirm support (lines 3930-3989)
- `_ralph_archive_cleanup()` - New function for cleanup logic (lines 3991-4086)
- `_ralph_archive_md()` - Updated with mode parameter for consistency (lines 4088-4169)

### Tests Added (6 new tests)
- `test_archive_parses_keep_flag` - Verifies --keep flag parsing
- `test_archive_parses_clean_flag` - Verifies --clean flag and story removal
- `test_archive_copies_progress_txt` - Verifies progress.txt archiving
- `test_archive_cleanup_creates_fresh_progress` - Verifies fresh progress.txt
- `test_archive_cleanup_resets_stats` - Verifies index.json stats reset
- `test_archive_rejects_unknown_flags` - Verifies error on invalid flags

### Learnings
- `gum confirm` defaults to "No" with `--default=false`
- ZSH arrays are 1-indexed, so `${array[1]}` is first element
- When rebuilding index.json, preserve blocked array but rebuild pending from remaining files
- Archive first, then cleanup - ensures full history preservation
- Use `(N)` glob qualifier to handle empty directories gracefully

## Iteration 10 - US-042: Pre-commit hook runs tests
**Status**: COMPLETED

Added test suite execution to the pre-commit hook. Tests now run automatically on every commit, ensuring code quality is maintained.

### Changes Made
- `.githooks/pre-commit` - Added step 7 (Test Suite) that runs `tests/test-ralph.zsh`
- Restructured hook to run tests for ALL commits (not just when .zsh files staged)
- Steps 1-5 (syntax checks) only run when .zsh files are staged
- Steps 6-8 (JSON validation, tests, AGENTS.md sync) always run
- Updated all step numbers from 7 to 8 total

### Files Modified
- `/Users/etanheyman/Desktop/Gits/ralphtools/.githooks/pre-commit` - Added test suite section
- `/Users/etanheyman/Desktop/Gits/ralphtools/scripts/setup-hooks.sh` - Updated summary to mention test suite
- `/Users/etanheyman/Desktop/Gits/ralphtools/CLAUDE.md` - Added pre-commit test hook documentation

### Learnings
- Pre-commit hooks should run tests for ALL commits, not just code changes
- Tests ensure any config/schema changes don't break functionality
- Execution time: ~1 second total (35 tests + all checks)
- `--no-verify` is built-in git feature for bypassing hooks

## Iteration 11 - BUG-003: fswatch background job outputs TTY noise
**Status**: COMPLETED

Fixed the fswatch background job to stop outputting job control messages like `[4] 73252` and `suspended (tty output)`.

### Root Cause
When ZSH starts a background job with `(...)&`, it outputs job control messages. Additionally, background processes trying to write to stdout can trigger "suspended (tty output)" messages.

### Solution
1. Added `setopt LOCAL_OPTIONS NO_MONITOR NO_NOTIFY` before starting the background job
2. Changed from `(...)&` to `{...} </dev/null >/dev/null 2>&1 &` to detach from TTY
3. Used ZSH coproc to start fswatch/inotifywait and capture its PID
4. Stored fswatch PID in `/tmp/ralph_watcher_$$_pid` for precise cleanup
5. Updated `_ralph_stop_watcher()` to kill both the wrapper shell and the actual fswatch process

### Files Modified
- `/Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh`
  - `_ralph_start_watcher()`: Added TTY detachment, coproc usage, PID file creation
  - `_ralph_stop_watcher()`: Added PID file-based cleanup for precise process termination

### Learnings
- `setopt NO_MONITOR NO_NOTIFY` suppresses ZSH job control output
- `&!` disowns immediately but doesn't capture PID in `$!`; use `& ; disown` instead
- Pipelines in backgrounded braces need special handling - `coproc` provides cleaner PID capture
- FIFO writes inside subshells with redirected outer stdout still work because they use explicit file paths
- When using `disown`, `wait` won't work on the process, so kill and brief sleep is sufficient

## Iteration 12 - US-035: Worktrees skill (task isolation)
**Status**: COMPLETED

Created `/worktrees` skill for git worktree-based task isolation. Enables creating isolated working directories for each task, preventing cross-contamination between branches.

### Skill Structure Created
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/worktrees/SKILL.md` - Router with quick actions table
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/worktrees/workflows/create.md` - Create worktree from branch name
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/worktrees/workflows/list.md` - List active worktrees
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/worktrees/workflows/switch.md` - Navigate between worktrees
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/worktrees/workflows/cleanup.md` - Remove completed worktrees
- `/Users/etanheyman/Desktop/Gits/ralphtools/skills/worktrees/workflows/from-linear.md` - Create worktree from Linear issue
- Symlinked to ~/.claude/commands/worktrees

### Features
- Default path: `~/worktrees/<repo>/<branch>`
- Linear integration: Auto-generates branch names from Linear issues (branchName field)
- Custom branch naming options: feature/ENG-123-description, fix/ENG-456-description
- Interactive selection with gum integration
- Shell function (`wt`) for quick switching with fuzzy matching
- Safe cleanup workflow with merge verification
- VS Code/Cursor integration instructions

### Learnings
- Linear issues have `branchName` field with auto-sanitized branch names
- `git worktree add <path> -b <branch>` creates worktree with new branch
- `git worktree remove <path>` removes worktree and cleans git references
- `git worktree prune` cleans up stale references from deleted directories
- Skills that are purely markdown (no standalone scripts) don't need zsh typecheck

## Iteration 13 - US-047: Script-backed Convex skill (deterministic execution)
**Status**: COMPLETED

Upgraded the Convex skill to use the deterministic script pattern from docs/skill-creation-guide.md. Scripts execute WITHOUT loading code into context - only output enters the conversation.

### Scripts Created
- `skills/convex/scripts/dev.sh` - Start dev server with auto-cleanup of orphan .js files
- `skills/convex/scripts/deploy.sh` - Production deployment with optional 1Password key retrieval
- `skills/convex/scripts/run-function.sh` - Execute queries/mutations/actions with arg validation
- `skills/convex/scripts/export-data.sh` - Database backup with timestamped filename
- `skills/convex/scripts/import-data.sh` - Data import with safety prompts and backup warnings

### Script Pattern Applied
All scripts follow the deterministic pattern:
- `set -e` for exit on error
- Color-coded output (RED/GREEN/YELLOW/BLUE)
- `-h/--help` flag for usage documentation
- Structured output (SUCCESS/ERROR prefix) for agent parsing
- Input validation before execution

### SKILL.md Updated
Added "Available Scripts" section with usage table:
```markdown
| Script | Purpose | Usage |
|--------|---------|-------|
| `scripts/dev.sh` | Start dev server with auto-cleanup | `bash ~/.claude/commands/convex/scripts/dev.sh` |
| `scripts/deploy.sh` | Deploy to production | `bash ~/.claude/commands/convex/scripts/deploy.sh --1p` |
...
```

### Workflows Simplified
All workflow files (dev.md, deploy.md, etc.) now:
- Route to scripts in "Quick Start" section
- Document options via tables
- Provide examples and troubleshooting
- No longer contain inline bash code blocks for execution

### Files Modified
- `skills/convex/scripts/dev.sh` - NEW
- `skills/convex/scripts/deploy.sh` - NEW
- `skills/convex/scripts/run-function.sh` - NEW
- `skills/convex/scripts/export-data.sh` - NEW
- `skills/convex/scripts/import-data.sh` - NEW
- `skills/convex/SKILL.md` - Added "Available Scripts" section
- `skills/convex/workflows/dev.md` - Simplified to route to script
- `skills/convex/workflows/deploy.md` - Simplified to route to script
- `skills/convex/workflows/run-function.md` - Simplified to route to script
- `skills/convex/workflows/data-export.md` - Simplified to route to script
- `skills/convex/workflows/data-import.md` - Simplified to route to script

### Learnings
- Scripts execute without loading code into context - only output enters conversation
- Agent invokes script, gets clean result - no interpretation, no construction, no errors
- Workflows become routing docs, not execution instructions
- Structured output (SUCCESS/ERROR prefix) enables reliable agent parsing
- Pre-written scripts are more reliable than generated code

## Iteration 14 - US-048: Audit all skills for script-backed pattern compliance
**Status**: COMPLETED

Audited all skills and upgraded Linear, Archive, and Ralph-install to the script-backed pattern.

### Skills Audit Results

**Already Script-backed (before this iteration):**
- `convex` - 5 scripts (dev.sh, deploy.sh, run-function.sh, export-data.sh, import-data.sh)
- `1password` - 2 scripts (migrate-env.sh, scan-mcp-secrets.sh)

**Upgraded to Script-backed:**
- `linear` - 3 new scripts
- `archive` - 2 new scripts
- `ralph-install` - 3 new scripts

**MD-only (no scripts needed):**
- `skills.md` - Discovery only
- `github.md` - Routes to gh CLI
- `brave.md` - Browser tool reference
- `prd.md` - PRD generation
- `critique-waves.md` - Agent orchestration
- `worktrees` - Simple git commands

### Scripts Created

**Linear Skill (`skills/linear/scripts/`):**
- `create-issue.sh` - Create Linear issues with priority, labels, assignee
- `list-issues.sh` - List/search issues with filters (--my, --team, --search, --issue)
- `create-worktree.sh` - Create git worktree from Linear issue with branch name

**Archive Skill (`skills/archive/scripts/`):**
- `archive-snapshot.sh` - Create timestamped PRD archive
- `cleanup-completed.sh` - Archive then remove completed stories

**Ralph-install Skill (`skills/ralph-install/scripts/`):**
- `check-deps.sh` - Check all required dependencies
- `install-deps.sh` - Install missing deps via Homebrew
- `validate.sh` - Full installation validation

### SKILL.md Updates

Added "Available Scripts" table to:
- `skills/linear/SKILL.md`
- `skills/archive/SKILL.md`
- `skills/ralph-install/SKILL.md`

### Documentation

Added "When to Use Scripts vs Workflows" section to `docs/skills.md`:
- When to use scripts: API calls, multi-step operations, validation
- When to use workflows: Simple CLI commands, decision trees, documentation
- Script template pattern with colors, help, structured output

### All Scripts Pass Pattern Requirements
- `set -e` for exit on error
- Color-coded output (RED/GREEN/YELLOW/BLUE)
- `-h/--help` flag for usage
- Structured output (SUCCESS/ERROR prefixes)

### Learnings
- 8 new scripts total, all pass bash -n typecheck
- Script-backed skills are more reliable than inline code blocks
- Workflows become routing docs that point to scripts
- Pattern: SKILL.md has "Available Scripts" table at top

## Iteration 15 - US-049: Hot-reload update.json each iteration
**Status**: COMPLETED

Implemented hot-reload of update.json at the START of each Ralph iteration, allowing new stories to be injected mid-run without waiting for the current batch to complete.

### Changes Made

**Enhanced `_ralph_apply_update_queue()` function:**
- Now processes `newStories` array: creates story files in `stories/`, adds to `pending` and `storyOrder`
- Now processes `updateStories` array: merges changes into existing story files
- Recalculates all stats after processing: `total`, `completed`, `pending`, `blocked`
- Sets `nextStory` based on updated `pending` array
- Sets `RALPH_UPDATES_APPLIED` global for caller to display count
- Clears `newStories` from index.json after processing
- Deletes `update.json` after successful processing

**Moved update check to START of iteration loop:**
- Check happens BEFORE `_ralph_json_next_story()` is called
- Ensures newly injected stories are immediately available
- Also calls `_ralph_auto_unblock()` to handle blocker resolution

**Updated message output:**
- Shows "üì• Applied N new story/stories from update.json" when stories are added
- Message appears at both iteration start and after final loop

### Files Modified
- `/Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh`
  - `_ralph_apply_update_queue()`: Complete rewrite with newStories/updateStories support
  - Main loop: Added update check at START of each iteration (line ~2698)
  - Between iterations: Removed redundant update check (was line ~3351)
  - After loop: Updated to show message when stories applied (line ~3413)

### Learnings
- While loops in ZSH run in subshells, so counters inside don't persist - use jq to re-count
- ZSH glob `(N)` qualifier handles empty directories gracefully
- `jq -c '.array[] | .'` iterates array items as compact JSON, one per line
- Stats recalculation must read all story files to count `passes: true`
- `nextStory` should be set to first item in `pending` array or `null` if empty

## Iteration 16 - BUG-004: Display stats don't refresh after update.json merge
**Status**: COMPLETED (already fixed by US-049)

This bug was automatically fixed as part of the US-049 implementation. The `_ralph_apply_update_queue()` function now:
1. Recalculates all stats (total, completed, pending, blocked) from story files
2. Writes fresh stats to index.json immediately after applying updates
3. All display functions read from index.json directly, so they get fresh values

### Verification
Tested with a scenario:
- Initial: 5 total, 3 completed, 2 pending (displayed as 3/5 = 60%)
- Added 2 new stories via update.json
- After update: 7 total, 3 completed, 4 pending (displayed as 3/7 = 42%)

Stats refresh correctly because:
- `_ralph_apply_update_queue()` recalculates stats from story files
- Stats are written to index.json immediately
- `_ralph_show_iteration_status()` reads from index.json (not cached)
- Progress bar shows fresh values on next display

No additional code changes needed - US-049 fix covered this bug.

## Iteration 17 - BUG-005: Ralph keeps looping after PRD complete
**Status**: COMPLETED

Fixed the bug where Ralph would keep looping after all stories were complete, burning tokens unnecessarily.

### Root Cause
When `_ralph_json_next_story()` returned empty (no pending stories), Ralph didn't check for this condition. It would continue looping without any story to work on.

### Solution
Added a check right after getting `current_story` in the main iteration loop (line 2715-2762):
1. If `current_story` is empty AND we're in JSON mode
2. Check if `pending` array length is 0
3. If so, display completion message and exit with code 0

### Completion Message Format
Normal mode:
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  ‚úÖ PRD Complete! All N stories finished.                      ‚ïë
‚ï†‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ï£
‚ïë  ‚è±Ô∏è  Total time: Xm Ys                                         ‚ïë
‚ïë  üí∞ Total cost: $X.XX                                          ‚ïë
‚ïë  üîÑ Iterations: N                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

Compact mode:
```
‚úÖ PRD COMPLETE! All N stories finished ‚îÇ Xm Ys ‚îÇ $X.XX
```

### Features
- Graceful exit with return 0
- Stops file watcher before exiting
- Sends notification if enabled
- Shows total time, cost, and iterations
- Cleans up temp files

### Files Modified
- `/Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh` (lines 2715-2762)

### Learnings
- Check for empty story BEFORE the iteration starts, not just at completion signals
- The `<promise>COMPLETE</promise>` signal was intended for when Claude reports completion, but Ralph itself needs to detect the empty-pending case
- Exit early, not late - don't burn an iteration asking Claude "what's the next task?" when there are none

## Iteration 18 - BUG-006: Debug output 'remaining_stats' leaking to display
**Status**: COMPLETED

Fixed the debug output `remaining_stats='0 0'` that was leaking to the terminal when user's shell had xtrace enabled.

### Root Cause
When a user's shell has `set -x` (xtrace) enabled globally, ZSH outputs debug traces to stderr for each command/assignment. The `_ralph_json_remaining_stats` function was being called in several places WITHOUT `2>/dev/null`, allowing xtrace output to leak to the terminal.

Lines 3261, 3316, and 3388 were calling `_ralph_json_remaining_stats` without stderr redirection, while lines 3403 and 3475 already had `2>/dev/null`.

### Solution
1. Added `2>/dev/null` to all calls of `_ralph_json_remaining_stats` that were missing it:
   - Line 3261: `skip_stats=$(_ralph_json_remaining_stats "$PRD_JSON_DIR" 2>/dev/null)`
   - Line 3316: `error_stats=$(_ralph_json_remaining_stats "$PRD_JSON_DIR" 2>/dev/null)`
   - Line 3388: `blocked_stats=$(_ralph_json_remaining_stats "$PRD_JSON_DIR" 2>/dev/null)`

2. Added belt-and-suspenders protection by adding `setopt localoptions noxtrace` at the start of the `_ralph_json_remaining_stats` function itself.

### Files Modified
- `/Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh`
  - `_ralph_json_remaining_stats()`: Added `setopt localoptions noxtrace` (line 2242)
  - Line 3261: Added `2>/dev/null` to skip_stats assignment
  - Line 3316: Added `2>/dev/null` to error_stats assignment
  - Line 3388: Added `2>/dev/null` to blocked_stats assignment

### Learnings
- ZSH xtrace outputs to stderr, so `2>/dev/null` suppresses it when capturing command output
- `setopt localoptions noxtrace` only takes effect AFTER it executes, so the setopt line itself may still produce trace output
- For belt-and-suspenders protection, use BOTH: noxtrace in the function AND `2>/dev/null` at call sites
- The output format `varname='value'` is the telltale sign of xtrace debug output

## Iteration 19 - BUG-007: Per-project ntfy topics not working
**Status**: COMPLETED

Fixed the bug where config file `ntfyTopic` value was overriding per-project topic logic, causing all Ralph instances to send notifications to the same fixed topic.

### Root Cause
When config file had `ntfyTopic` set (even to defaults like "ralph-notifications"), it was loaded into `RALPH_NTFY_TOPIC` global variable. Later, the per-project fallback logic `${RALPH_NTFY_TOPIC:-${RALPH_NTFY_PREFIX}-${project_name}}` never triggered because `RALPH_NTFY_TOPIC` was already set.

### Solution
1. Changed config loading logic to only set `RALPH_NTFY_TOPIC` if the config value is non-empty, not "auto", and not "null"
2. Empty string `""` or `"auto"` in config now enables per-project topics (recommended default)
3. Updated `ralph-setup` wizard to offer "Per-project topics (recommended)" vs "Fixed topic" choice
4. Updated both gum and fallback (read-based) setup flows

### Files Modified
- `/Users/etanheyman/Desktop/Gits/ralphtools/ralph.zsh`
  - Config loading (lines 1195-1200): Added conditional to skip setting `RALPH_NTFY_TOPIC` for empty/"auto" values
  - Setup wizard gum flow (lines 892-909): Added topic mode choice
  - Setup wizard fallback flow (lines 944-972): Added topic mode choice
- `/Users/etanheyman/Desktop/Gits/ralphtools/docs/notifications.md`
  - Added "Config File (ralph-config.json)" section explaining per-project vs fixed topic configuration

### Learnings
- Config values of empty string, "auto", or not set should all enable per-project behavior
- Setup wizards should default to per-project and make fixed topic opt-in
- The display at line 2677 already correctly shows the actual topic being used
