# Ralph Progress - Fresh Start
Started: Fri Jan 23 21:57:15 IST 2026

(Previous progress archived to docs.local/prd-archive/)

## Iteration 1
Story: AUDIT-001 - Audit README.md for accuracy and relevance
Status: BLOCKED
Reason: AUDIT-001 depends on US-073 (Deprecate -G -H -K model flags) which is still pending.
The acceptance criteria "Remove -G -H -K examples (deprecated per US-073)" cannot be completed until US-073 is done.
Moved AUDIT-001 to blocked array, set nextStory to BUG-013.

### Learnings
- Always check dependencies[] field in story JSON before starting
- If a dependency story is not completed, the dependent story should be blocked

## Iteration 2
Story: BUG-013 - Debug output 'remaining_stats' still leaking to display
Status: COMPLETED (opus)
Changes:
- Added `setopt localoptions noxtrace` to 10+ helper functions to prevent xtrace output leakage
- Functions guarded: _ralph_format_elapsed, _ralph_show_iteration_status, _ralph_get_story_criteria_progress, _ralph_get_total_criteria, _ralph_update_criteria_display_at_row, _ralph_update_stories_display_at_row, _ralph_handle_file_change, _ralph_handle_file_change_with_rows, _ralph_start_polling_loop, _ralph_ntfy
- Added debug output auditing section to docs/configuration.md with grep commands
- Added comment "# DEBUG OUTPUT - guard with RALPH_DEBUG_LIVE" above _ralph_debug_live function

### Learnings
- The xtrace output format `var='value value'` with single quotes indicates zsh trace output, not explicit echo
- `setopt localoptions noxtrace` prevents xtrace leakage within function scope
- Even if parent function sets noxtrace, it's good practice to guard all helper functions defensively

## Iteration 3
Story: BUG-014 - Ralph exits early when Claude falsely signals COMPLETE
Status: COMPLETED (opus)
Changes:
- Created `_ralph_verify_pending_count()` helper function to check actual pending count
- Supports both JSON mode (checks pending array length) and PRD.md mode (counts `- [ ]` checkboxes)
- Updated main COMPLETE detection code to use the helper function
- Added 5 unit tests for the verification function (all pass)
- Fixed bug: grep -c returns exit code 1 with 0 matches, needs proper handling

### Learnings
- `grep -c` returns 0 (the count) but with exit code 1 when no matches - don't use `|| echo 0` which prints twice
- Proper pattern: `actual_pending=$(grep -c 'pattern' file 2>/dev/null) || actual_pending=0`
- Extract verification logic into testable functions for easier unit testing

## Iteration 4
Story: BUG-015 - Ralph says 'PRD Complete' when stories are blocked
Status: COMPLETED (opus)
Changes:
- Modified completion check at line ~3197 in ralph.zsh to also check blocked count
- Added `blocked_count=$(jq -r '.blocked | length')` check alongside pending_count
- If pending=0 but blocked>0, shows "PRD Blocked: X stories need manual intervention" in yellow box
- Uses RALPH_COLOR_YELLOW for blocked state visual distinction
- Added 2 unit tests for blocked story completion logic (all 43 tests pass)
- Notification event "blocked" sends when PRD is blocked vs "complete"

### Learnings
- PRD completion state has 3 outcomes: complete (pending=0,blocked=0), blocked (pending=0,blocked>0), or in-progress
- Use different colors (green vs yellow) to visually distinguish completion states
- Singular/plural handling: "1 story" vs "X stories" for user-friendly messages

## Iteration 5
Story: BUG-016 - update.json format undocumented and confusing
Status: COMPLETED (opus)
Changes:
- Added comprehensive update.json format documentation to skills/update/SKILL.md
- Documented that only `newStories` and `updateStories` arrays are processed
- Fixed update-story.md workflow: removed incorrect nested `changes` key format
- Fields in updateStories should be at top level with `id`, not nested under `changes`
- Added validation in `_ralph_apply_update_queue()` to warn about ignored fields
- Warning displays for any keys besides newStories/updateStories (e.g., storyOrder, pending)
- Tested merge functionality - story creation, index.json update, and update.json cleanup all work
- All 43 tests pass

### Learnings
- jq's `.[0] * .[1]` merge operator means updateStories fields must be at top level with id
- Documentation discrepancies can lead to silent failures (storyOrder/pending were being ignored)
- Adding validation warnings helps users catch format mistakes early

## Iteration 6
Story: US-052 - Audit Skills for Structure Compliance
Status: COMPLETED (opus)
Changes:
- Scanned ~/.claude/commands/ for all 14 skills (11 directory-based, 3 single-file)
- Checked against reference pattern: github skill (SKILL.md + workflows/ + scripts/)
- Created comprehensive audit report at docs.local/skill-audit-report.md
- Found 6 fully compliant, 5 partially compliant, 3 non-compliant (single files)
- Critical finding: brave.md and brave/ both exist (duplicate skill)
- Medium priority: brave/, coderabbit/, worktrees/ have bash refs but no scripts/
- Low priority: critique-waves and update have sparse scripts/

### Learnings
- Single-file skills may be appropriate if simple/linear (prd.md, skills.md)
- Duplicate skills cause confusion (brave.md vs brave/ directory)
- Skills referencing external CLIs don't necessarily need scripts/ (already have CLI)

## Iteration 7
Story: US-070 - Convex skill: Complete user deletion pattern
Status: COMPLETED (opus)
Changes:
- Created ~/.claude/commands/convex/workflows/user-deletion.md with complete deletion pattern
- Documented: find user by email (getUserByEmail query with by_email index)
- Documented: delete from auth tables (sessions, accounts, verificationTokens, users - order matters)
- Documented: delete from all app tables with userId foreign key (helper function pattern)
- Included table discovery query and grep command (discoverUserTables)
- Included complete deleteUserAndAllData mutation code with deletion report
- Documented required indexes (by_user, by_email) in schema.ts section
- Added CLI command: npx convex run admin:deleteUserAndAllData
- Updated SKILL.md Quick Actions table with link to new workflow
- All 8 acceptance criteria met

### Learnings
- Auth table deletion order matters: sessions→accounts→tokens→user (avoid FK issues)
- Include deletion report in response for audit/compliance tracking
- Table discovery requires manual schema.ts check (Convex has no introspection API)

## Iteration 8
Story: US-071 - Pre-commit test hook for ralphtools
Status: COMPLETED (opus)
Changes:
- Pre-commit hook already existed at .githooks/pre-commit (git config core.hooksPath .githooks)
- Hook already runs tests/test-skills.zsh (lines 254-280)
- Hook already validates JSON files with jq (lines 198-214)
- Hook already exits non-zero on failure (lines 316-323)
- Hook already has --no-verify bypass documentation (line 321, setup-hooks.sh:90)
- Hook completes in ~2.6 seconds (< 10 seconds requirement met)
- ADDED: shellcheck for .sh files (lines 64-85) - previously only .zsh files had syntax checking
- shellcheck exclusions: SC1091 (sourced files), SC2034 (unused vars in sourced files)

### Learnings
- The pre-commit hook was 95% complete - only missing shellcheck for .sh files
- shellcheck doesn't support .zsh files (SC1071 error) - use zsh -n instead
- Hook uses .githooks/ directory with git config core.hooksPath (not .git/hooks/)
